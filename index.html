<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comrades Welfare Portal</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --welfare-blue: #003366;
            --active-red: #d63031;
            --light-bg: #f8f9fa;
            --success: #27ae60;
            --accent: #3498db;
            --danger: #e74c3c;
            --text: #2d3436;
        }

        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--light-bg); color: var(--text); }

        .header {
            background: var(--welfare-blue);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .header h1 { margin: 0; font-size: 28px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .header h2 { font-size: 16px; margin-top: 5px; }

        .admin-btn {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 22px;
            cursor: pointer;
            background: rgba(255,255,255,0.15);
            padding: 10px;
            border-radius: 50%;
            border: 2px solid white;
            transition: 0.3s;
        }
        .admin-btn:hover { background: var(--active-red); border-color: var(--active-red); }

        .nav-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: white;
            border-bottom: 2px solid #ddd;
        }

        .nav-item {
            padding: 20px 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            color: var(--welfare-blue);
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .nav-item.active { background: var(--active-red); color: white; }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            min-height: 500px;
        }

        .page { display: none; animation: slideIn 0.4s ease-out; }
        .page.active { display: block; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f1f2f6; color: var(--welfare-blue); font-weight: bold; }
        
        .status-pill {
            padding: 5px 10px;
            color: white;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 11px;
            display: inline-block;
            border-radius: 4px;
        }
        .status-approved { background-color: var(--success); }
        .status-pending, .status-rejected { background-color: var(--active-red); }

        .form-card { background: #f9f9f9; padding: 25px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #eee; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; font-family: inherit; }
        
        .btn-main { background: var(--welfare-blue); color: white; border: none; padding: 15px; border-radius: 6px; font-size: 18px; font-weight: 700; cursor: pointer; width: 100%; }
        
        .action-btn { padding: 6px 10px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; font-size: 11px; margin-left: 5px; }
        .btn-view { color: var(--accent); cursor: pointer; font-weight: bold; text-decoration: underline; }
        .btn-del { background: var(--danger); }
        .btn-app { background: var(--success); }
        .btn-rej { background: var(--danger); }

        .admin-section { border: 2px dashed var(--active-red); padding: 20px; border-radius: 10px; margin-bottom: 30px; background: #fff8f8; }
        .details-cell { white-space: pre-wrap; line-height: 1.6; vertical-align: top; }

        .footer { background: var(--welfare-blue); color: white; text-align: center; padding: 30px 20px; margin-top: 50px; font-size: 14px; }
        
        tfoot tr td { background: #f1f2f6; font-weight: bold; color: var(--welfare-blue); border-top: 2px solid var(--welfare-blue); }

        /* Fullscreen Photo Styles */
        #photo-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        #photo-overlay img { max-width: 95%; max-height: 95%; border: 3px solid white; }
        #photo-overlay .close-overlay {
            position: absolute;
            top: 20px; right: 20px;
            color: white; font-size: 30px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<div id="photo-overlay">
    <span class="close-overlay" onclick="closePhoto()">&times;</span>
    <img id="overlay-img" src="">
</div>

<div class="header">
    <h1>COMRADES WELFARE</h1>
    <h2>Management Information System</h2>
    <div class="admin-btn" id="lock-icon" onclick="toggleAdmin()">üîí</div>
</div>

<div class="nav-bar">
    <div class="nav-item active" id="tab-dashboard" onclick="showPage('dashboard')">Dashboard</div>
    <div class="nav-item" id="tab-registration" onclick="showPage('registration')">Registration</div>
    <div class="nav-item" id="tab-records" onclick="showPage('records')">Records</div>
    <div class="nav-item" id="tab-rules" onclick="showPage('rules')">Rules</div>
</div>

<div class="container">
    
    <div id="dashboard" class="page active">
        <h3 style="color: var(--welfare-blue);">üìã Welfare Member List</h3>
        <div class="table-responsive">
            <table id="members-table">
                <thead>
                    <tr>
                        <th>NO.</th>
                        <th>NAME</th>
                        <th>PHONE</th>
                        <th>SAVINGS</th>
                        <th>STATUS</th>
                        <th>PHOTO</th>
                        <th class="admin-only-cell" style="display: none;">ACTION</th>
                    </tr>
                </thead>
                <tbody id="dash-list"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right;">TOTAL SAVINGS:</td>
                        <td id="total-savings-cell" colspan="4">0</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div id="registration" class="page">
        <div id="admin-history" class="admin-section" style="display: none;">
            <h3 style="color: var(--active-red); margin-top: 0;">üõ†Ô∏è Admin Approval Panel</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr><th>NAME</th><th>PHONE</th><th>ACTION</th></tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>
        </div>

        <div class="form-card">
            <h3 style="margin-top:0;">New Member Signup</h3>
            <label style="font-weight:600">Full Name</label>
            <input type="text" id="name-in" placeholder="ENTER YOUR FULL NAME" oninput="this.value = this.value.toUpperCase()">
            <label style="font-weight:600">Phone Number</label>
            <input type="text" id="phone-in" placeholder="e.g. 0712345678">
            <label style="font-weight:600">Member Photo</label>
            <input type="file" id="photo-in" accept="image/*">
            <button class="btn-main" onclick="submitReg()">SUBMIT REGISTRATION</button>
        </div>
    </div>

    <div id="records" class="page">
        <h3 style="color: var(--welfare-blue);">üí∞ Collection Records</h3>
        <div class="search-box">
            <input type="text" id="record-search" placeholder="Search Receiver or Details..." onkeyup="renderRecords()" style="margin-bottom:20px; width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;">
        </div>

        <div id="admin-record-entry" class="admin-section" style="display: none;">
            <h3 style="color: var(--active-red); margin-top: 0;">üõ†Ô∏è Add New Record</h3>
            <input type="date" id="rec-date">
            <input type="text" id="rec-memno" placeholder="Member No (Optional Reference)">
            <input type="text" id="rec-person" placeholder="Received By">
            <textarea id="rec-details" rows="4" placeholder="Transaction Details..."></textarea>
            <button class="btn-main" onclick="addRecord()" style="background: var(--success);">SAVE RECORD</button>
        </div>

        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>RECEIVER</th>
                        <th>DETAILS</th>
                        <th class="admin-only-cell" style="display: none;">ACTION</th>
                    </tr>
                </thead>
                <tbody id="record-list"></tbody>
            </table>
        </div>
    </div>

    <div id="rules" class="page">
        <h3 style="color: var(--welfare-blue);">üìú Welfare Rules</h3>
        <div id="admin-rules-section" class="admin-section" style="display: none;">
            <textarea id="rules-input" rows="10" style="width:100%"></textarea>
            <button class="btn-main" onclick="updateRules()" style="background: var(--success);">SAVE RULES</button>
        </div>
        <div class="rules-box" id="rules-display"></div>
    </div>

</div>

<div class="footer">
    <strong>COMRADES WELFARE SYSTEM </strong><br>
    MORGAN HOGAN &copy; 2026<br>
    <small>IT TECHNICIAN; MORGAN HOGAN </small>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDBTDFtl3cpPrSY45fM8o73Zy5D-ARPaxE",
      authDomain: "comrades-storage.firebaseapp.com",
      databaseURL: "https://comrades-storage-default-rtdb.firebaseio.com",
      projectId: "comrades-storage",
      storageBucket: "comrades-storage.firebasestorage.app",
      messagingSenderId: "892097114915",
      appId: "1:892097114915:web:48eedf218e65bb45a11296"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let members = [];
    let financialRecords = [];
    let welfareRules = "";
    let isAdmin = false;
    const secret = "NDE3MzgyMDg="; 

    db.ref('welfare_system_data').on('value', (snapshot) => {
        const data = snapshot.val() || {};
        members = data.members || [];
        financialRecords = data.records || [];
        welfareRules = data.rules || "1. Respect all members.\n2. Pay contributions on time.";
        renderDashboard();
        renderRecords();
        renderHistory();
        renderRules();
    });

    function save() {
        db.ref('welfare_system_data').set({
            members: members,
            records: financialRecords,
            rules: welfareRules
        });
    }

    async function submitReg() {
        const name = document.getElementById('name-in').value.toUpperCase();
        const phone = document.getElementById('phone-in').value;
        const photoFile = document.getElementById('photo-in').files[0];
        if(!name || !phone) return alert("Please fill Name and Phone.");
        
        let photoBase64 = "";
        if(photoFile) photoBase64 = await convertAndCompress(photoFile);

        members.push({ id: Date.now(), memNo: 999999, displayNo: '---', name, phone, photo: photoBase64, status: 'pending', savings: 0 });
        save();
        alert("Registration submitted!");
        document.getElementById('name-in').value = ''; document.getElementById('phone-in').value = ''; document.getElementById('photo-in').value = '';
        showPage('dashboard');
    }

    function convertAndCompress(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 300;
                    const scale = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    }

    function viewPhoto(data) {
        document.getElementById('overlay-img').src = data;
        document.getElementById('photo-overlay').style.display = 'flex';
    }

    function closePhoto() {
        document.getElementById('photo-overlay').style.display = 'none';
    }

    function renderDashboard() {
        const list = document.getElementById('dash-list');
        const totalCell = document.getElementById('total-savings-cell');
        let totalSavings = 0;

        list.innerHTML = [...members].sort((a,b)=>a.memNo-b.memNo).map(m => {
            const savingsVal = parseFloat(m.savings) || 0;
            totalSavings += savingsVal;
            
            return `
                <tr>
                    <td style="color:var(--active-red); font-weight:800">${m.displayNo} ${isAdmin?`<button onclick="editNumber(${m.id})">E</button>`:''}</td>
                    <td><b>${m.name}</b></td>
                    <td>${m.phone}</td>
                    <td>${m.savings} ${isAdmin?`<button onclick="editSavings(${m.id})">E</button>`:''}</td>
                    <td><span class="status-pill status-${m.status}">${m.status}</span></td>
                    <td>${m.photo ? `<span class="btn-view" onclick="viewPhoto('${m.photo}')">VIEW</span>` : 'N/A'}</td>
                    <td class="admin-only-cell" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                        <button class="action-btn btn-del" onclick="deleteMember(${m.id})">Del</button>
                    </td>
                </tr>
            `;
        }).join('');
        
        totalCell.innerText = totalSavings.toLocaleString();
    }

    function renderRecords() {
        const list = document.getElementById('record-list');
        const search = document.getElementById('record-search').value.toLowerCase();
        const filtered = financialRecords.filter(r => r.receiver.toLowerCase().includes(search) || r.details.toLowerCase().includes(search));
        
        list.innerHTML = filtered.map(r => `
            <tr>
                <td><b>${r.date}</b></td>
                <td><b>${r.receiver}</b></td> <td class="details-cell">${r.details}</td>
                <td class="admin-only-cell" style="display: ${isAdmin ? 'table-cell' : 'none'}">
                    <button class="action-btn btn-del" onclick="deleteRec(${r.id})">Del</button>
                </td>
            </tr>
        `).join('');
    }

    function toggleAdmin() {
        if (!isAdmin) {
            const pass = prompt("Admin Password:");
            if (btoa(pass) === secret) {
                isAdmin = true;
                document.getElementById('lock-icon').innerText = "üîì";
                updateAdminView("block", "table-cell");
            }
        } else {
            isAdmin = false;
            document.getElementById('lock-icon').innerText = "üîí";
            updateAdminView("none", "none");
        }
        renderDashboard(); renderRecords();
    }

    function updateAdminView(b, t) {
        document.getElementById('admin-history').style.display = b;
        document.getElementById('admin-record-entry').style.display = b;
        document.getElementById('admin-rules-section').style.display = b;
        document.querySelectorAll('.admin-only-cell').forEach(el => el.style.display = t);
    }

    function showPage(p) {
        document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + p).classList.add('active');
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
        document.getElementById(p).classList.add('active');
    }

    function addRecord() {
        const date = document.getElementById('rec-date').value;
        const memNo = document.getElementById('rec-memno').value || "N/A";
        const person = document.getElementById('rec-person').value;
        const details = document.getElementById('rec-details').value;
        if(!date || !person || !details) return alert("Fill required fields (Date, Receiver, Details).");
        financialRecords.unshift({id: Date.now(), date, memNo, receiver: person, details});
        save();
        document.getElementById('rec-memno').value = ''; document.getElementById('rec-details').value = '';
    }

    function deleteRec(id) { if(confirm("Delete record?")) { financialRecords = financialRecords.filter(r => r.id !== id); save(); } }
    function setMemberStatus(id, stat) { members = members.map(m => m.id === id ? {...m, status: stat} : m); save(); }
    function deleteMember(id) { if(confirm("Delete member?")) { members = members.filter(m => m.id !== id); save(); } }
    function editSavings(id) {
        const m = members.find(x => x.id === id);
        const amt = prompt("New Savings:", m.savings);
        if(amt) { members = members.map(x => x.id === id ? {...x, savings: amt} : x); save(); }
    }
    function editNumber(id) {
        const m = members.find(x => x.id === id);
        const no = prompt("New No:", m.displayNo);
        if(no) { members = members.map(x => x.id === id ? {...x, displayNo: no, memNo: parseInt(no)} : x); save(); }
    }
    function renderHistory() {
        const list = document.getElementById('history-list');
        const pending = members.filter(m => m.status === 'pending');
        list.innerHTML = pending.map(m => `
            <tr><td>${m.name}</td><td>${m.phone}</td>
            <td><button class="action-btn btn-app" onclick="setMemberStatus(${m.id},'approved')">‚úî</button>
            <button class="action-btn btn-rej" onclick="setMemberStatus(${m.id},'rejected')">‚úò</button></td></tr>
        `).join('') || '<tr><td colspan="3">None</td></tr>';
    }
    function updateRules() { welfareRules = document.getElementById('rules-input').value; save(); }
    function renderRules() { document.getElementById('rules-display').innerText = welfareRules; document.getElementById('rules-input').value = welfareRules; }
</script>
</body>
</html>